# Release playbook: bump version, create release branch, tag, and trigger build
# Usage examples:
#   ansible-playbook ansible/playbooks/storefront/release.yml -e bump=patch
#   ansible-playbook ansible/playbooks/storefront/release.yml -e bump=minor
#   ansible-playbook ansible/playbooks/storefront/release.yml -e bump=major
#   ansible-playbook ansible/playbooks/storefront/release.yml -e bump=patch -e dry_run=true
---
- name: Release Storefront
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - "{{ playbook_dir }}/sandbox.vars.yml"

  vars:
    # Version bump type: patch, minor, or major
    bump: "patch"
    # Set to true to skip push and workflow trigger
    dry_run: false
    # Source branch to create release from
    source_branch: "main"
    # Path to package.json
    package_json_path: "{{ playbook_dir }}/../../../package.json"

  tasks:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Validation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Validate bump type
      ansible.builtin.assert:
        that:
          - bump in ['patch', 'minor', 'major']
        fail_msg: "Invalid bump type '{{ bump }}'. Must be one of: patch, minor, major"

    - name: Check gh CLI installed
      ansible.builtin.command:
        cmd: gh --version
      changed_when: false

    - name: Ensure gh is authenticated
      ansible.builtin.command:
        cmd: gh auth status -h github.com
      register: gh_auth
      changed_when: false
      failed_when: false

    - name: Fail if gh is not authenticated
      ansible.builtin.fail:
        msg: "gh is not authenticated. Run `gh auth login` and try again."
      when: gh_auth.rc != 0

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Git state validation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Get git root directory
      ansible.builtin.command:
        cmd: git rev-parse --show-toplevel
        chdir: "{{ playbook_dir }}"
      register: git_root
      changed_when: false

    - name: Set repo root fact
      ansible.builtin.set_fact:
        repo_root: "{{ git_root.stdout }}"

    - name: Check for uncommitted changes
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: "{{ repo_root }}"
      register: git_status
      changed_when: false

    - name: Fail if there are uncommitted changes
      ansible.builtin.fail:
        msg: |
          Working directory has uncommitted changes. Please commit or stash them first.
          {{ git_status.stdout }}
      when: git_status.stdout | length > 0

    - name: Fetch latest from origin
      ansible.builtin.command:
        cmd: git fetch origin
        chdir: "{{ repo_root }}"
      changed_when: false

    - name: Checkout source branch
      ansible.builtin.command:
        cmd: git checkout {{ source_branch }}
        chdir: "{{ repo_root }}"
      changed_when: false

    - name: Pull latest changes
      ansible.builtin.command:
        cmd: git pull origin {{ source_branch }}
        chdir: "{{ repo_root }}"
      changed_when: false

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Version calculation
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Read package.json
      ansible.builtin.slurp:
        src: "{{ repo_root }}/package.json"
      register: package_json_content

    - name: Parse current version
      ansible.builtin.set_fact:
        package_json: "{{ package_json_content.content | b64decode | from_json }}"

    - name: Extract version parts
      ansible.builtin.set_fact:
        current_version: "{{ package_json.version }}"
        version_parts: "{{ package_json.version.split('.') }}"

    - name: Calculate new version
      ansible.builtin.set_fact:
        new_version: >-
          {%- set major = version_parts[0] | int -%}
          {%- set minor = version_parts[1] | int -%}
          {%- set patch = version_parts[2] | int -%}
          {%- if bump == 'major' -%}
            {{ major + 1 }}.0.0
          {%- elif bump == 'minor' -%}
            {{ major }}.{{ minor + 1 }}.0
          {%- else -%}
            {{ major }}.{{ minor }}.{{ patch + 1 }}
          {%- endif -%}

    - name: Set release branch and tag names
      ansible.builtin.set_fact:
        release_branch: "releases/v{{ new_version | trim }}"
        release_tag: "v{{ new_version | trim }}"

    - name: Show release plan
      ansible.builtin.debug:
        msg:
          - "ðŸ“¦ Release Plan"
          - "  Current version: {{ current_version }}"
          - "  Bump type: {{ bump }}"
          - "  New version: {{ new_version | trim }}"
          - "  Release branch: {{ release_branch }}"
          - "  Release tag: {{ release_tag }}"
          - "  Dry run: {{ dry_run }}"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Create release branch
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Check if release branch already exists
      ansible.builtin.command:
        cmd: git branch -a --list "*{{ release_branch }}"
        chdir: "{{ repo_root }}"
      register: branch_exists
      changed_when: false

    - name: Fail if release branch already exists
      ansible.builtin.fail:
        msg: "Release branch '{{ release_branch }}' already exists!"
      when: branch_exists.stdout | length > 0

    - name: Check if tag already exists
      ansible.builtin.command:
        cmd: git tag -l "{{ release_tag }}"
        chdir: "{{ repo_root }}"
      register: tag_exists
      changed_when: false

    - name: Fail if tag already exists
      ansible.builtin.fail:
        msg: "Tag '{{ release_tag }}' already exists!"
      when: tag_exists.stdout | length > 0

    - name: Create release branch
      ansible.builtin.command:
        cmd: git checkout -b {{ release_branch }}
        chdir: "{{ repo_root }}"
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Update package.json version
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Update version in package.json
      ansible.builtin.replace:
        path: "{{ repo_root }}/package.json"
        regexp: '"version":\s*"[^"]+"'
        replace: '"version": "{{ new_version | trim }}"'

    - name: Commit version bump
      ansible.builtin.command:
        cmd: "git commit -am 'chore(release): bump version to {{ new_version | trim }}'"
        chdir: "{{ repo_root }}"
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Create tag
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Create release tag
      ansible.builtin.command:
        cmd: git tag -a {{ release_tag }} -m "Release {{ new_version | trim }}"
        chdir: "{{ repo_root }}"
      changed_when: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Push (skip if dry_run)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Push release branch
      ansible.builtin.command:
        cmd: git push -u origin {{ release_branch }}
        chdir: "{{ repo_root }}"
      when: not dry_run | bool
      changed_when: true

    - name: Push release tag
      ansible.builtin.command:
        cmd: git push origin {{ release_tag }}
        chdir: "{{ repo_root }}"
      when: not dry_run | bool
      changed_when: true

    - name: Show dry run skip message
      ansible.builtin.debug:
        msg: "ðŸ”¸ Dry run: skipping push (workflow will not be triggered)"
      when: dry_run | bool

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Summary
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Show success summary
      ansible.builtin.debug:
        msg:
          - "âœ… Release {{ release_tag }} created successfully!"
          - ""
          - "ðŸ“‹ Summary:"
          - "  Version: {{ current_version }} â†’ {{ new_version | trim }}"
          - "  Branch: {{ release_branch }}"
          - "  Tag: {{ release_tag }}"
          - "{% if not dry_run | bool %}  Build workflow auto-triggered on push to {{ release_branch }}{% endif %}"
          - ""
          - "ðŸ”— Links:"
          - "  Branch: https://github.com/{{ gh_repo_owner }}/{{ gh_repo_name }}/tree/{{ release_branch }}"
          - "  Tag: https://github.com/{{ gh_repo_owner }}/{{ gh_repo_name }}/releases/tag/{{ release_tag }}"
          - "  Actions: https://github.com/{{ gh_repo_owner }}/{{ gh_repo_name }}/actions"

    - name: Return to source branch
      ansible.builtin.command:
        cmd: git checkout {{ source_branch }}
        chdir: "{{ repo_root }}"
      changed_when: false
